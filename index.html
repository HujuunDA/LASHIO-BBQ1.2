<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Order System</title>
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; background-color: #f4f4f4; padding-bottom: 90px; -webkit-text-size-adjust: 100%; touch-action: manipulation; } 
        button:active, .menu-item:active, .table-item:active { transform: scale(0.96); transition: transform 0.1s; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #FF8C00; color: white; position: fixed; width: 100%; top: 0; box-sizing: border-box; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 60px; }
        .table-trigger { background: #FF4500; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 14px; border: 2px solid rgba(255,255,255,0.3); min-width: 70px; text-align: center; }
        .settings-btn { background: none; border: none; padding: 5px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .settings-btn svg { fill: white; width: 28px; height: 28px; }
        .menu-container { margin-top: 65px; }
        .category-header { background-color: #fff5e6; color: #FF8C00; padding: 12px 15px; font-weight: 800; position: sticky; top: 60px; z-index: 5; border-bottom: 1px solid #ffe0b2; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; background-color: white; padding: 18px 15px; border-bottom: 1px solid #f0f0f0; }
        .item-info .name { font-size: 18px; font-weight: 600; color: #222; }
        .item-info .price { font-size: 14px; color: #FF8C00; margin-top: 4px; font-weight: bold; }
        .quantity-control { display: flex; align-items: center; gap: 12px; }
        .control-btn { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #FF8C00; background: white; color: #FF8C00; font-size: 20px; font-weight: bold; display: flex; justify-content: center; align-items: center; }
        .control-btn.add { background: #FF8C00; color: white; border: none; }
        .qty-num { font-size: 18px; font-weight: bold; min-width: 24px; text-align: center; }
        .hidden-v { visibility: hidden; opacity: 0; }
        .bottom-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: white; position: fixed; width: 100%; bottom: 0; box-sizing: border-box; box-shadow: 0 -3px 12px rgba(0,0,0,0.1); z-index: 90; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        .view-btn { background: linear-gradient(135deg, #FF8C00, #FF4500); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; font-size: 15px; }
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 88%; max-width: 350px; box-sizing: border-box; }
        .table-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .table-item { padding: 15px 0; text-align: center; border-radius: 12px; font-size: 18px; font-weight: 800; background: #eee; color: #888; border: 2px solid transparent; }
        .table-item.has-order { background: #fff3e0; color: #FF8C00; border: 2px solid #FFCC80; }
        .table-item.active { background: #FF8C00 !important; color: white !important; }
        .admin-option { display: block; padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 12px; border-left: 5px solid #FF8C00; color: #333; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <header class="top-nav">
        <div class="table-trigger" onclick="openTableModal()">·Äù·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ <span id="display-table-id">1</span> ‚ñæ</div>
        <input type="text" id="notes-input" placeholder="·Äô·Äæ·Äê·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫..." style="flex:1; margin: 0 10px; padding:10px; border-radius:12px; border:none; font-size:14px;" oninput="saveNotes(this.value)">
        <button class="settings-btn" onclick="openAdminModal()">
            <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.85,9.48l2.03,1.58C4.84,11.36,4.81,11.69,4.81,12c0,0.31,0.02,0.65,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5 s1.57-3.5,3.5-3.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z"/></svg>
        </button>
    </header>

    <main id="menu-list" class="menu-container"></main>

    <footer class="bottom-bar">
        <div>
            <div style="font-size:11px; color:#888;">·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏ <span id="total-count" style="color:#FF8C00; font-weight:bold;">0</span> ·ÄÅ·ÄØ</div>
            <div style="font-weight:900; font-size:18px; color:#FF4500;"><span id="total-money">0</span> <small>Ks</small></div>
        </div>
        <button class="view-btn" onclick="openOrderDetails()">·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Ää·Ä∫ / ·Ä°·Äû·Ä±·Ä∏·ÄÖ·Ä≠·Äê·Ä∫</button>
    </footer>

    <div id="admin-modal" class="modal" onclick="closeModal(event, 'admin-modal')">
        <div class="modal-content">
            <h3 style="text-align:center; margin-top:0; color:#FF8C00; font-size:18px;">·Äï·Äº·ÄØ·Äï·Äº·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏</h3>
            <a href="edit_menu.html" class="admin-option">üìù ·Äü·ÄÑ·Ä∫·Ä∏·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÑ·Ä∫·Äõ·Äî·Ä∫</a>
            <a href="income_summary.html" class="admin-option">üí∞ ·Äî·Ä±·Ä∑·ÄÖ·Äâ·Ä∫·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·ÄÅ·Äª·ÄØ·Äï·Ä∫</a>
            <button onclick="hideModal('admin-modal')" style="width:100%; padding:12px; border-radius:12px; border:none; background:#eee;">·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫</button>
        </div>
    </div>

    <div id="table-modal" class="modal" onclick="closeModal(event, 'table-modal')">
        <div class="modal-content">
            <h3 style="margin:0; text-align:center; font-size:18px;">·Äù·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·Äï·Ä´</h3>
            <div class="table-grid" id="table-grid"></div>
            <button onclick="hideModal('table-modal')" style="width:100%; margin-top:20px; padding:12px; border:none; color:#999;">·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫</button>
        </div>
    </div>

    <div id="order-modal" class="modal" onclick="closeModal(event, 'order-modal')">
        <div class="modal-content">
            <h3 id="order-title">·Äô·Äæ·Ä¨·Äö·Ä∞·Äô·Äæ·ÄØ·Ä°·Äû·Ä±·Ä∏·ÄÖ·Ä≠·Äê·Ä∫</h3>
            <div id="order-list-box" style="max-height:300px; overflow-y:auto; border-top:1px solid #eee; margin:15px 0; padding:10px 0;"></div>
            <div id="order-total-price" style="text-align:right; font-weight:900; color:#FF4500; font-size:1.5em; margin-bottom:20px;"></div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <button onclick="processCheckout()" style="padding:14px; border:none; background:#34c759; color:white; border-radius:12px; font-weight:bold;">·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äô·Ää·Ä∫ (Checkout)</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="hideModal('order-modal')" style="flex:1; padding:12px; border:1px solid #ddd; background:#fff; border-radius:12px;">·Äï·Äº·Äî·Ä∫·Äë·ÄΩ·ÄÄ·Ä∫</button>
                    <button onclick="clearCurrentTable()" style="flex:1; color:#ff3b30; border:1px solid #ff3b30; background:none; border-radius:12px;">·Äñ·Äª·ÄÄ·Ä∫·Äô·Ää·Ä∫</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MENU_KEY = 'bbq_app_local_cache';
        const ORDER_KEY = 'REST_V10_ORDERS';
        const HISTORY_KEY = 'REST_V10_HISTORY';

        let menu_data = [];
        let all_orders = {}; 
        let current_table = "1";

        function init() {
            const savedMenu = localStorage.getItem(MENU_KEY);
            menu_data = savedMenu ? JSON.parse(savedMenu).menu_data : [];
            const savedOrders = localStorage.getItem(ORDER_KEY);
            if(savedOrders) all_orders = JSON.parse(savedOrders);
            renderMenu();
            renderTableGrid();
        }

        function renderMenu() {
            const list = document.getElementById('menu-list');
            if(menu_data.length === 0) {
                list.innerHTML = '<div style="text-align:center;padding:50px;color:#999;">·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã</div>';
                return;
            }
            const categories = [...new Set(menu_data.map(i => i.category))];
            let html = '';
            categories.forEach(cat => {
                html += `<div class="category-header">${cat}</div>`;
                menu_data.filter(i => i.category === cat).forEach(item => {
                    const myOrder = all_orders[current_table] || {items: []};
                    const found = myOrder.items.find(o => o.name === item.name);
                    const qty = found ? found.quantity : 0;
                    html += `<div class="menu-item" onclick="updateQty('${item.name}', 1)">
                        <div class="item-info">
                            <div class="name">${item.name}</div>
                            <div class="price">${Number(item.price).toLocaleString()} Ks</div>
                        </div>
                        <div class="quantity-control">
                            <div class="btn-box ${qty === 0 ? 'hidden-v' : ''}" onclick="updateQty('${item.name}', -1, event)">
                                <button class="control-btn">-</button>
                            </div>
                            <span class="qty-num ${qty === 0 ? 'hidden-v' : ''}">${qty}</span>
                            <div class="btn-box" onclick="updateQty('${item.name}', 1, event)">
                                <button class="control-btn add">+</button>
                            </div>
                        </div>
                    </div>`;
                });
            });
            list.innerHTML = html;
            refreshBottomUI();
        }

        function updateQty(name, delta, event) {
            if(event) event.stopPropagation();
            if(!all_orders[current_table]) all_orders[current_table] = {items: [], notes: ""};
            let items = all_orders[current_table].items;
            let idx = items.findIndex(i => i.name === name);
            if(idx > -1) {
                items[idx].quantity += delta;
                if(items[idx].quantity <= 0) items.splice(idx, 1);
            } else if(delta > 0) {
                const dish = menu_data.find(i => i.name === name);
                items.push({...dish, quantity: 1});
            }
            localStorage.setItem(ORDER_KEY, JSON.stringify(all_orders));
            renderMenu();
        }

        function refreshBottomUI() {
            const order = all_orders[current_table] || {items: []};
            const total = order.items.reduce((s, i) => s + (i.price * i.quantity), 0);
            const count = order.items.reduce((s, i) => s + i.quantity, 0);
            document.getElementById('total-money').innerText = total.toLocaleString();
            document.getElementById('total-count').innerText = count;
            document.getElementById('notes-input').value = order.notes || "";
        }

        function switchTable(id) { current_table = id; document.getElementById('display-table-id').innerText = id; hideModal('table-modal'); renderMenu(); }

        function renderTableGrid() {
            const grid = document.getElementById('table-grid');
            grid.innerHTML = '';
            for(let i=1; i<=12; i++) {
                const id = i.toString();
                const hasOrder = all_orders[id] && all_orders[id].items.length > 0;
                grid.innerHTML += `<div class="table-item ${hasOrder?'has-order':''} ${id===current_table?'active':''}" onclick="switchTable('${id}')">${i}</div>`;
            }
        }

        function openOrderDetails() {
            const order = all_orders[current_table] || {items: []};
            const list = document.getElementById('order-list-box');
            let h = '';
            order.items.forEach(i => {
                h += `<div style="display:flex;justify-content:space-between;padding:10px 0;"><span>${i.name} x ${i.quantity}</span><b>${(i.price*i.quantity).toLocaleString()}</b></div>`;
            });
            list.innerHTML = h || '·Äò·Ä¨·Äô·Äæ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã';
            const total = order.items.reduce((s, i) => s + (i.price * i.quantity), 0);
            document.getElementById('order-total-price').innerText = `·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏: ${total.toLocaleString()} Ks`;
            document.getElementById('order-modal').style.display = 'flex';
        }

        function processCheckout() {
            const order = all_orders[current_table];
            if(!order || order.items.length === 0) return;
            if(!confirm(`·Äù·Ä≠·ÄØ·ÄÑ·Ä∫·Ä∏ ${current_table} ·ÄÄ·Ä≠·ÄØ ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äô·Äæ·Ä¨·Äû·Ä±·ÄÅ·Äª·Ä¨·Äû·Äú·Ä¨·Ä∏?`)) return;
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
            history.push({ table: current_table, items: [...order.items], notes: order.notes, total: order.items.reduce((s, i) => s + (i.price * i.quantity), 0), timestamp: Date.now() });
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            all_orders[current_table] = {items: [], notes: ""};
            localStorage.setItem(ORDER_KEY, JSON.stringify(all_orders));
            location.reload();
        }

        function clearCurrentTable() { if(confirm("·Äû·Ä±·ÄÅ·Äª·Ä¨·Äû·Äú·Ä¨·Ä∏?")) { all_orders[current_table] = {items: [], notes: ""}; localStorage.setItem(ORDER_KEY, JSON.stringify(all_orders)); location.reload(); } }
        function openAdminModal() { document.getElementById('admin-modal').style.display = 'flex'; }
        function openTableModal() { renderTableGrid(); document.getElementById('table-modal').style.display = 'flex'; }
        function hideModal(id) { document.getElementById(id).style.display = 'none'; }
        function closeModal(e, id) { if(e.target.id === id) hideModal(id); }
        function saveNotes(v) { if(!all_orders[current_table]) all_orders[current_table] = {items: [], notes: ""}; all_orders[current_table].notes = v; localStorage.setItem(ORDER_KEY, JSON.stringify(all_orders)); }

        init();
    </script>
</body>
</html>
