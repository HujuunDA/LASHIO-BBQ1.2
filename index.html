<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>烧烤账单计算器10.19.17.00</title> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* ----------------------- CSS 样式区 - 界面布局和美化 ----------------------- */
        
        /* 引入现代字体 */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        /* 整体页面样式 */
        body {
            font-family: 'Poppins', 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            background: linear-gradient(135deg, #e36711, #ffbe91);
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #333;
            margin: 0;
        }

        /* 关键：控制不同桌子菜单的显示状态 */
        .table-menu-container {
            display: none;
        }
        .table-menu-container.active {
            display: block;
        }
        
        /* 隐藏数量输入框的上下箭头 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* ----------------------- 打印样式 (用于图片转换时的样式基准) ----------------------- */
           
        #print-area {
            /* 允许 JS 临时设置为 'block' */
            display: none; 
            
            /* 模拟收据纸宽度，确保图片尺寸合理 */
            width: 300px; 
            margin: 0; 
            padding: 10px;
            background-color: #fff; /* 背景色必须是白色，否则图片会透明 */
            font-family: 'Microsoft YaHei', 'SimHei', monospace;
            font-size: 14px;
            line-height:1.5;
            color: #000;
            box-sizing: border-box;
            position: absolute; /* 防止在页面上占位 */
            top: -9999px; /* 移到屏幕外 */
            left: -9999px;
            z-index: 9999;
            opacity: 0; /* 默认隐藏，用于防止闪烁 */
        }
        #print-area h2 {
            text-align: center;
            font-size: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
            margin-bottom: 10px;
            color: #000;
        }
        #print-area p {
            margin: 5px 0;
            font-size: 12px;
        }
        #print-area .print-item {
            display: flex;
            justify-content: space-between;
            margin-bottom:4px;
            font-size: 14px;
        }
        #print-area .print-total {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            border-top: 2px solid #000;
            padding-top: 10px;
            margin-top: 10px;
        }
        #print-area .print-info {
            font-size: 12px;
            margin-bottom: 10px;
        }
        #print-area hr {
            border: none;
            border-top: 1px dashed #000;
            margin: 10px 0;
        }
        
        /* ----------------------- 顶部控制栏样式 ----------------------- */
        .top-bar {
            display: flex;
            justify-content: flex-end; /* 修改: 将所有元素靠右对齐 */
            align-items: center;
            margin-bottom: 20px;
            z-index: 100;
            flex-wrap: nowrap;
            gap: 10px; /* 新增: 添加元素之间的间距 */
        }
        /* 调整: 取消 .top-bar .dropdown 的左边距 */
        .top-bar .dropdown {
            margin-left: 0; 
        }

     /* 备注输入框容器样式 - **修改以匹配按钮尺寸** */
        .note-input-container {
            display: flex;
            align-items: center;
            margin-top: 5px; /* 【新增】略微向下移动备注框 */
            /* 统一大小的参考值：dropbtn 默认高度是 12px*2(padding) + font-size */
            width: 150px; /* 默认宽度 */
        }

        /* 备注输入框样式 - **修改以匹配按钮尺寸** */
        .note-input {
            padding: 12px 20px; /* 匹配 .dropbtn 的 padding */
            border: 1px solid #ff7e5f;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            font-size: 14px; /* 略小于 dropbtn 的 16px */
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            height: 44px; /* 统一高度，根据 padding 和 font-size 估算 */
        }

        /* 下拉菜单基础样式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* 下拉菜单按钮 - **统一大小** */
        .dropbtn {
            background-color: #ff7e5f;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s, transform 0.2s;
            height: 44px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 设置按钮图标样式 - **统一大小** */
        #settings-dropbtn {
            font-size: 24px;
            width: 44px; 
            padding: 0; 
        }

        /* 按钮悬停效果 */
        .dropbtn:hover {
            background-color: #ff5e3a;
            transform: translateY(-2px);
        }

        /* 下拉菜单内容容器 */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            min-width: 100px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            right: 0;
            border-radius: 8px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
            /* 【修改点 1】靠右对齐 */
            text-align: right; 
        }

        .dropdown-content a:hover {
            background-color: rgba(255, 126, 95, 0.2);
        }

        /* 【修改点 2】新增：自定义添加桌号链接样式 */
        .add-table-link {
            color: #27ae60 !important; /* 绿色 */
            font-weight: bold;
        }

        /* 鼠标悬停在下拉菜单按钮上时显示内容 */
        .dropdown:hover .dropdown-content {
            display: block;
        }
        
        /* ----------------------- 主体内容区样式 ----------------------- */
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* 卡片容器基础样式 */
        .container, .bill-details-wrapper, .summary-total, .menu-editor-container, #summary-content {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            overflow-x: hidden; 
        }
        
        /* 账单明细容器 */
        .bill-details-wrapper {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 100px;
        }

        /* 标题样式 */
        h2 {
            border-bottom: 2px solid #ffc3a0;
            padding-bottom: 15px;
            margin-top: 0;
            color: #f39c12;
            font-weight: 600;
        }
        
        /* ----------------------- 移动端整体优化 - 自适应布局 ----------------------- */
        @media (max-width: 767px) {
            
            /* (1) 基础布局和间距压缩 */
            body {
                padding: 8px; /* 缩小边距 */
            }

            /* 调整容器内边距 */
            .container, .bill-details-wrapper, .summary-total, .menu-editor-container, #summary-content {
                padding: 12px; /* 缩小内边距 */
            }

            /* (2) 顶部控制栏优化 */
            .top-bar {
                margin-bottom: 10px;
                flex-wrap: wrap; 
                gap: 5px; /* 减小顶部元素间距 */
            }
            .note-input-container {
                flex-grow: 1; 
                max-width: none; 
                width: auto;
                order: 1;
                margin-bottom: 5px; /* 底部留白 */
            }
            
            /* 确保备注输入框在小屏幕上保持与按钮组一致的高度 */
            .note-input {
                padding: 6px 8px; /* 进一步缩小 padding */
                font-size: 13px;
                height: 32px; /* 统一更小的高度 */
            }
            
            /* 小屏按钮统一尺寸 */
            .dropbtn {
                padding: 6px 8px;
                font-size: 13px;
                height: 32px; /* 统一更小的高度 */
                order: 2; 
            }
            #settings-dropbtn {
                font-size: 18px;
                width: 32px;
                height: 32px;
            }
            .table-selector-dropdown {
                 order: 3;
            }
            .settings-dropdown {
                 order: 4;
            }
            
            /* (3) 账单明细压缩 */
            #bill-details .item-row {
                margin-bottom: 5px; /* 缩小行间距 */
                padding: 5px 0;
                font-size: 0.9em; /* 略微缩小字体 */
            }
            
            /* 账单总计压缩 */
            .total {
                font-size: 1.5em; 
            }
            
            /* 结算按钮压缩 */
            .action-buttons button {
                 padding: 8px 15px;
                 font-size: 0.9em;
            }
            
            /* * 【【【 这是修改点 (1) - 移动端菜单布局 】】】
             * 替换 1.html 的 (4) 菜单卡片优化 
             * 采用 2.html 的 (4) 菜单列表优化 
             */
            .item {
                padding: 8px 0; /* 减少卡片内边距 */
                font-size: 0.9em;
            }
            
            /* 修正移动端菜品名称字体大小 */
            .item-info h3 {
                /* 根据整体放大后的比例调整，防止在小屏幕上过于拥挤 */
                font-size: 1.6em; /* 调整列表项字体大小 */
            }
            .item-controls button {
                width: 23px; /* 保持按钮尺寸 */
                height: 23x;
            }
            .item-controls input {
                width: 25px; /* 调整输入框宽度 */
            }
            
            /* * 移除 1.html 中的 核心修改：移除强制缩放 部分
             */
        }
        /* ----------------------- 菜品分类样式 ----------------------- */
        .category-section {
            margin-top: 25px;
            border: 1px solid #ffc3a0;
            border-radius: 10px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.7);
        }

        .category-header {
            background-color: #ff7e5f;
            color: white;
            padding: 15px 20px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: default;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* 【【【 这是修改点 (2) - 菜单内容布局 】】】 */
        /* 采用 2.html 的列表布局 (column) */
        .category-content {
            padding: 0 10px; /* 调整 padding 以贴合列表 */
            display: flex; 
            flex-direction: column; /* **修改：列表式布局** */
            gap: 0; /* 移除列表项之间的间距 */
        }

        /* Hide the first top margin to prevent double spacing */
        .category-section:first-child {
            margin-top: 0;
        }

        /* * 【【【 这是修改点 (3) - 菜品项样式 】】】
         * 整体替换 1.html 的卡片样式 (.item, .item-image, .item-info, .item-controls)
         * 采用 2.html 的列表行样式
         */
        
        /* ----------------------- 菜品项样式 (列表行) ----------------------- */
        
        .item {
            display: flex;
            justify-content: space-between; /* 左右对齐 */
            align-items: center; /* 垂直居中 */
            padding: 10px 0; /* 列表行的垂直内边距 */
            background-color: transparent; 
            border-radius: 0;
            box-shadow: none;
            transition: background-color 0.2s ease;
            cursor: default; /* 列表模式不点击整行点单 */
            width: 100%;
            box-sizing: border-box;
            border-bottom: 1px dashed rgba(255, 126, 95, 0.5); /* 列表分隔线 */
        }
        
        /* 移除最后一个列表项的下边框 */
        .category-content .item:last-child {
            border-bottom: none; 
        }

        .item:hover {
            background-color: rgba(255, 126, 95, 0.1);
            transform: none; /* 移除悬停动画 */
            box-shadow: none;
        }
        
        /* 移除了 1.html 的 .item-image 样式 */

        .item-info {
            flex-grow: 1; /* 占据剩余空间 */
            margin-bottom: 0;
            padding-right: 15px;
            min-width: 0;
            cursor: pointer; /* **新增：指针，表示可点击** */
        }
        
        /* !!! 关键修改: 放大菜品名称字体 !!! */
        .item-info h3 {
            font-size: 2.3em; /* **修改：菜单名称放大 (原 1.4em)** */
            margin: 0 0 3px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            font-weight: 600;
        }

        .item-info p {
            font-size: 0.9em;
            margin: 0;
            color: #555;
        }

        /* 数量控制区：改为垂直排列 */
        .item-controls {
            display: flex;
            flex-direction: column; /* **修改：垂直上下排列** */
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 5px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            min-width: 40px; /* 确保有足够的宽度 */
        }

        .item-controls input {
            width: 30px; 
            height: 25px; /* 调整高度 */
            text-align: center;
            margin: 3px 0; /* 垂直间距 */
            border: none;
            background-color: transparent;
            font-size: 1.1em;
            font-weight: 700;
        }
        
        .item-controls button {
            background-color: #ff7e5f;
            color: white;
            border: none;
            padding: 0;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em; /* 按钮字号略微放大 */
            width: 30px; /* 按钮尺寸 */
            height: 30px; /* 按钮尺寸 */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        .item-controls button:hover {
            background-color: #ff5e3a;
            transform: scale(1.05);
        }
        /* --- 列表行样式替换结束 --- */


        /* ----------------------- 账单明细样式 ----------------------- */
        /* 账单明细中的行样式 (性能优化：将item-row用于JS查找) */
        #bill-details .item-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #ffc3a0;
        }
        
        #bill-details .item-total {
            min-width: 100px;
            text-align: right;
            font-weight: 600;
        }
        
        /* 总计金额样式 */
        .total {
            font-size: 1.8em;
            font-weight: 700;
            text-align: right;
            color: #f39c12;
            padding-top: 15px;
        }

        /* 备注显示区样式 (新增) */
        #current-note-display {
            text-align: right; 
            margin-bottom: 10px; 
            font-size: 1.1em; 
            color: #555;
            min-height: 25px; /* 确保占位 */
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        /* 结算按钮样式 */
        .action-buttons button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .action-buttons button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        /* ----------------------- 菜单编辑模式样式 ----------------------- */
        .menu-editor-container {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .menu-editor-container table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-bottom: 20px;
        }
        
        .menu-editor-container th,
        .menu-editor-container td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .menu-editor-container th {
            background-color: rgba(255, 195, 160, 0.3);
        }
        
        .menu-editor-container input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .menu-editor-container button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        
        .menu-editor-container button:hover {
            background-color: #2980b9;
        }
        
        .add-new {
            background-color: #27ae60 !important;
            padding: 10px 20px !important;
        }
        
        .add-new:hover {
            background-color: #219653 !important;
        }

        /* ----------------------- 汇总模式样式 ----------------------- */
        #summary-content {
            background-color: rgba(255, 255, 255, 0.4);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        
        .daily-summary-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
        }
        
        .daily-summary-section h3 {
            color: #f39c12;
            margin-top: 0;
        }
        
        .daily-summary-section .daily-total {
            font-weight: bold;
            color: #e74c3c;
        }
        
        #grand-total {
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #f39c12;
        }
        
        .summary-action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .summary-action-buttons button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .summary-action-buttons button.export {
            background-color: #27ae60;
        }
        
        .summary-action-buttons button:hover {
            opacity: 0.9;
        }

        /* 新增：订单详情样式 */
        .order-details {
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
        }

        .order-details p {
            margin: 5px 0;
        }

        .order-items {
            list-style-type: none;
            padding: 0;
        }

        .order-items li {
            margin-bottom: 5px;
        }
        
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="note-input-container">
            <input type="text" id="order-note-input" placeholder="输入备注..." class="note-input">
        </div>

        <div class="dropdown table-selector-dropdown">
            <button id="table-selector-dropbtn" class="dropbtn table-selector-dropbtn">桌号</button>
            <div id="table-dropdown-content" class="dropdown-content">
                </div>
        </div>

        <div class="dropdown settings-dropdown">
            <button id="settings-dropbtn" class="dropbtn">&#9881;</button>
            <div id="action-dropdown" class="dropdown-content">
                <a href="#" id="summary-link" onclick="toggleSummaryMode()">查看汇总</a>
                <a href="#" id="edit-link" onclick="toggleEditMode()">编辑菜单</a>
            </div>
        </div>
    </div>

    <div id="main-content" class="main-container">
        <div class="container">
            <div id="menu-area"></div> 
        </div>
        
        <div class="bill-details-wrapper">
            <h2>账单明细</h2>
            <div id="bill-details"></div>
        </div>
        
        <div class="summary-total">
            <div id="current-note-display"></div>
            <hr>
            <div class="total">
                <p>总计：<span id="total-price">0.00</span> Ks</p>
            </div>
            <div class="action-buttons">
                <button id="settle-button" onclick="settleAndClear()">结算</button>
            </div>
        </div>
    </div>
    
    <div id="edit-content" class="menu-editor-container" style="display: none;">
        <h2>菜单编辑</h2>
        <table>
            <thead>
                <tr>
                    <th>名称</th>
                    <th>价格</th>
                    <th>分类</th> <th>图片</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="menu-editor-body">
                </tbody>
        </table>
        <button class="add-new" onclick="addNewItem()">添加新菜品</button>
        <button onclick="saveAllMenuItems()" style="background-color: #3498db; margin-left: 10px;">保存所有</button>
        <button onclick="toggleEditMode()" style="background-color: #95a5a6; margin-left: 10px;">返回点单</button>
    </div>

    <div id="summary-content" style="display: none;">
        <h2>资金汇总管理</h2>
        
        <div id="summary-nav" style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px;">
            <button onclick="showSummaryView('profit-loss')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #f39c12; color: white; font-weight: bold; opacity: 1.0;">损益汇总</button>
            <button onclick="showSummaryView('income')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #27ae60; color: white; font-weight: bold; opacity: 0.7;">收入管理</button>
            <button onclick="showSummaryView('expense')" style="padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; background-color: #e74c3c; color: white; font-weight: bold; opacity: 0.7;">支出管理</button>
        </div>

        <div id="profit-loss-view" style="display: block;">
            <h3 style="color: #f39c12; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">每日/每月损益汇总</h3>
            <div id="summary-container"></div>
            <div id="grand-total">总损益: 0 Ks</div>
        </div>
        
        <div id="income-view" style="display: none;">
            <h3 style="color: #27ae60; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">添加新的其他收入</h3>
            <div style="margin-bottom: 20px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                <input type="date" id="income-date" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="income-description" placeholder="收入描述" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" id="income-amount" placeholder="金额 (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="addIncome()" style="background-color: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">记录收入</button>
            </div>
            <h3 style="color: #27ae60; border-bottom: 1px dashed #ffc3a0; padding-bottom: 10px;">历史收入记录 (含销售订单)</h3>
            <div id="income-list" style="margin-top: 20px;"></div>
        </div>
        
        <div id="expense-view" style="display: none;">
            <h3 style="color: #e74c3c; border-bottom: 1px solid #ffc3a0; padding-bottom: 10px;">添加新的支出</h3>
            
            <div id="expense-entry-container" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                </div>
            
            <div style="margin-bottom: 20px; display: flex; gap: 10px;">
                 <button id="add-expense-row-btn" onclick="addNewExpenseRow()" style="background-color: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">添加一行</button>
                 <button onclick="addExpense()" style="background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">记录所有支出</button>
            </div>
            
            <h3 style="color: #e74c3c; border-bottom: 1px dashed #ffc3a0; padding-bottom: 10px;">历史支出记录</h3>
            <div id="expense-list" style="margin-top: 20px;"></div>
        </div>
        <div class="summary-action-buttons">
            <button class="export" onclick="exportToExcel()">导出历史账单</button>
            <button onclick="clearAllHistory()">清空所有历史账单</button>
            <button onclick="toggleSummaryMode()">返回点单</button>
        </div>
    </div>

    <div id="print-area"></div>

    <script>
        // --- 所有的 JS 逻辑将完全保留 1.html 的 ---
        // --- (除了 renderAllMenus 函数中的 HTML 结构) ---

        // --- IndexedDB 数据存储配置 ---
        const dbName = 'bbq_pos_db';
        const dbVersion = 1;
        const menuStoreName = 'menu_items';
        let db;
        
        // --- 全局变量和元素引用 ---
        let menuItems = [];
        // **修改点 1: 动态桌号管理**
        let activeTables = []; // 存储当前正在开单的桌号
        let currentTable = 1;
        
        let isEditMode = false;
        let isSummaryMode = false;

        // 获取 DOM 元素的引用
        const mainContent = document.getElementById('main-content');
        const editContent = document.getElementById('edit-content');
        const summaryContent = document.getElementById('summary-content');
        const menuArea = document.getElementById('menu-area');
        const billDetails = document.getElementById('bill-details');
        const totalPriceSpan = document.getElementById('total-price');
        const settleButton = document.getElementById('settle-button');
        const tableSelectorDropbtn = document.getElementById('table-selector-dropbtn');
        const tableDropdownContent = document.getElementById('table-dropdown-content');
        const editLink = document.getElementById('edit-link');
        const summaryLink = document.getElementById('summary-link');
        const printArea = document.getElementById('print-area'); 
        
        // 新增：备注输入框和显示区域的引用
        const orderNoteInput = document.getElementById('order-note-input');
        const currentNoteDisplay = document.getElementById('current-note-display'); 
        
        // 【新增】桌号选择器容器和备注输入框容器的引用
        const tableSelectorContainer = document.querySelector('.table-selector-dropdown'); 
        const noteInputContainer = document.querySelector('.note-input-container'); 

        // defaultPlaceholder 保持 1.html 的不变 (用于菜单编辑)
        const defaultPlaceholder = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMuLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgcng9IjgiIGZpbGw9IiNGRjNBNTAiLz4KPHBhdGggZD09Ik0zNSAzNUwzNSAyNUwzNSA0NU00NSAzNUwyNSAzNSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz4KPC9zdmc+Cg==";

        // --- 音频上下文全局管理 ---
        let audioContext;

        /** * 确保 AudioContext 在用户交互后处于活动状态 */
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error("AudioContext 初始化失败:", e);
                }
            }
        }

        // --- IndexedDB 数据库操作函数 (保留 1.html 的) ---

        /** * 打开或创建 IndexedDB 数据库 */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, dbVersion);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(menuStoreName)) {
                        db.createObjectStore(menuStoreName, { keyPath: 'id', autoIncrement: true });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB 错误:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        /** * 从数据库获取所有菜单项 */
        async function getMenuItems() {
            if (!db) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([menuStoreName], 'readonly');
                const store = transaction.objectStore(menuStoreName);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /** * 保存菜单项到数据库 (保留 1.html 的，含 image) */
        async function saveMenuItemToDB(item) {
            if (!db) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([menuStoreName], 'readwrite');
                const store = transaction.objectStore(menuStoreName);
                const request = store.put(item);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /** * 从数据库删除菜单项 */
        async function deleteMenuItemFromDB(id) {
            if (!db) await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([menuStoreName], 'readwrite');
                const store = transaction.objectStore(menuStoreName);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /** * 初始化默认菜单项 (保留 1.html 的) */
        async function initializeDefaultMenu() {
            const defaultMenu = [
                { name: "羊肉串", price: 2000, category: "肉类" },
                { name: "牛肉串", price: 2500, category: "肉类" },
                { name: "鸡翅", price: 3000, category: "肉类" },
                { name: "烤鱼", price: 5000, category: "海鲜/水产" },
                { name: "烤虾", price: 4000, category: "海鲜/水产" },
                { name: "烤玉米", price: 1500, category: "素菜" },
                { name: "烤茄子", price: 2000, category: "素菜" },
                { name: "啤酒", price: 3500, category: "酒水/饮料" },
                { name: "可乐", price: 1000, category: "酒水/饮料" },
                { name: "烤韭菜", price: 1500, category: "素菜" }
            ];
            
            if (!db) await openDB();
            const transaction = db.transaction([menuStoreName], 'readwrite');
            const store = transaction.objectStore(menuStoreName);
            
            for (const item of defaultMenu) {
                // 仅添加没有 ID 的新项目
                if (!item.id) {
                    store.add(item);
                } else {
                    store.put(item);
                }
            }
            
            return defaultMenu;
        }
        
        // 加载菜单项
        async function loadMenuItems() {
            try {
                const items = await getMenuItems();
                if (items.length === 0) {
                    menuItems = await initializeDefaultMenu();
                } else {
                    menuItems = items;
                }
            } catch (error) {
                console.error("加载菜单项失败:", error);
                menuItems = await initializeDefaultMenu();
            }
        }

        // --- 辅助工具函数 (保留 1.html 的) ---

        /**
         * 播放音效（用于点单反馈） 
         */
        function playSound() {
            // 异步执行，不阻塞主线程
            requestAnimationFrame(() => {
                if (!audioContext || audioContext.state === 'suspended') {
                    initAudioContext(); 
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume().catch(e => console.error("AudioContext 恢复失败:", e));
                    }
                }

                if (!audioContext || audioContext.state !== 'running') {
                    return;
                }

                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine'; 
                    oscillator.frequency.value = 800; 
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    
                    oscillator.start();
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
                    oscillator.stop(audioContext.currentTime + 0.05);

                    oscillator.onended = () => {
                        oscillator.disconnect();
                        gainNode.disconnect();
                    };

                } catch (e) {
                    console.error("音频播放失败:", e);
                }
            });
        }

        /**
         * 触发设备震动（用于点单反馈）
         */
        function vibrateDevice() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        /**
         * 获取当前日期字符串 (格式: YYYY-MM-DD)
         */
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * 计算给定订单的总价
         */
        function calculateTotal(orderData) {
            let total = 0;
            for (const itemName in orderData) {
                const quantity = orderData[itemName];
                const item = menuItems.find(i => i.name === itemName);
                if (item) {
                    total += item.price * quantity;
                }
            }
            return total;
        }

        /**
         * 从 LocalStorage 加载指定桌子的当前订单
         */
        function loadCurrentOrder(tableNumber) {
            const savedOrder = localStorage.getItem(`bbq_order_table_${tableNumber}`);
            return savedOrder ? JSON.parse(savedOrder) : {};
        }

        /**
         * 从 LocalStorage 加载指定桌子的备注
         */
        function loadTableNote(tableNumber) {
            return localStorage.getItem(`bbq_note_table_${tableNumber}`) || '';
        }

        // --- 核心点单逻辑函数 (保留 1.html 的) ---
        
        /** * 切换当前操作的桌号 */
        async function switchTable(tableNumber) {
            if (isEditMode || isSummaryMode) return;
            
            // **修改点: 新增桌号切换时的震动和声音反馈**
            playSound(); 
            vibrateDevice(); 
            
            // 切换菜单容器的显示状态 (使用 setTimeout 确保平滑切换)
            const currentMenuContainer = document.querySelector(`.table-menu-container.active`);
            const nextMenuContainer = document.getElementById(`table-${tableNumber}-menu`);
            
            if (currentMenuContainer) {
                currentMenuContainer.classList.remove('active');
            }
            
            // **动态渲染优化：如果目标菜单不存在，则重新渲染所有菜单**
            if (!nextMenuContainer) {
                currentTable = tableNumber;
                await renderAllMenus();
                generateTableSelectors();
                // 再次获取新渲染的菜单
                const newlyRenderedMenu = document.getElementById(`table-${tableNumber}-menu`);
                if(newlyRenderedMenu) {
                    newlyRenderedMenu.classList.add('active');
                }
            } else {
                nextMenuContainer.classList.add('active');
            }


            currentTable = tableNumber;
            localStorage.setItem('bbq_last_table', currentTable);

            tableSelectorDropbtn.textContent = (typeof tableNumber === 'number' || (!isNaN(parseInt(tableNumber)) && String(parseInt(tableNumber)) === String(tableNumber))) ? `${tableNumber}号桌` : String(tableNumber);
            settleButton.textContent = `结算并清空${tableSelectorDropbtn.textContent}`;
            
            // 加载备注信息到输入框
            orderNoteInput.value = loadTableNote(currentTable); 

            // **性能优化点**: 延迟更新账单
            setTimeout(() => {
                updateBill(); 
            }, 50);
        }
        
        /** * **新增功能:** 查找最小的、未被占用的桌号
         */
        function findNextAvailableTable() {
            // 确保 activeTables 包含有效数字且已排序
            const sortedTables = [...activeTables].filter(t => typeof t === 'number' && !isNaN(t)).sort((a, b) => a - b);
            let nextTable = 1;

            // 查找数组中缺失的最小正整数
            for (const tableNum of sortedTables) {
                if (tableNum === nextTable) {
                    nextTable++;
                } else if (tableNum > nextTable) {
                    // 找到空缺
                    return nextTable;
                }
            }
            // 如果没有空缺，则返回下一个最大的数字
            return nextTable;
        }

        /**
         * **修改功能:** 添加一个新的动态桌号，支持自定义
         */
        async function addNewTable() {
            // 1. 计算默认桌号 (最小可用)
            const defaultTableNumber = findNextAvailableTable();
            
            // 2. 弹出输入框供用户自定义
            const customInput = prompt(`输入新桌号 (数字或字母/中文)，留空则使用默认桌号: ${defaultTableNumber} 号桌`);

            let newTableIdentifier;

            if (customInput !== null && customInput.trim() !== "") {
                // 用户输入了自定义内容
                const trimmedInput = customInput.trim();
                
                // 尝试解析为数字 (如果能转为数字，则保留数字类型)
                const numberCheck = parseInt(trimmedInput);

                if (!isNaN(numberCheck) && numberCheck > 0 && String(numberCheck) === trimmedInput) {
                    newTableIdentifier = numberCheck;
                } else {
                    // 保持为字符串 (支持 'A桌', '包厢1' 等)
                    newTableIdentifier = trimmedInput;
                }
            } else {
                // 用户点击了取消或留空，使用默认桌号
                newTableIdentifier = defaultTableNumber;
            }
            
            // 3. 校验新桌号是否已存在
            if (activeTables.includes(newTableIdentifier)) {
                alert(`桌号 "${newTableIdentifier}" 已存在，请重新输入。`);
                return;
            }
            
            // 4. 添加到活跃列表
            activeTables.push(newTableIdentifier);
            
            // 排序: 数字在前，字符串在后 (简化排序，全部转为字符串再按数字/字典序混合排序)
            activeTables.sort((a, b) => {
                // 确保数字排序优先于字符串
                const aIsNum = typeof a === 'number' || (typeof a === 'string' && !isNaN(parseInt(a)));
                const bIsNum = typeof b === 'number' || (typeof b === 'string' && !isNaN(parseInt(b)));
                
                if (aIsNum && bIsNum) {
                    return (parseInt(a) || Infinity) - (parseInt(b) || Infinity);
                } else if (aIsNum) {
                    return -1; // 数字在前
                } else if (bIsNum) {
                    return 1;  // 字符串在后
                } else {
                    return String(a).localeCompare(String(b)); // 字符串按字典序
                }
            }); 
            
            // 5. 更新全局状态，切换到新桌号
            await switchTable(newTableIdentifier);

            // 6. 更新桌号下拉菜单
            generateTableSelectors();
            
            // 7. 提示
            alert(`已添加 "${newTableIdentifier}" 号桌`);
        }


        /**
         * 将账单内容转换为图片并下载 (此功能本身性能开销大，但在结算时只发生一次)
         */
        function printBillToImage() {
            const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}号桌` : String(currentTable);
            const currentOrder = loadCurrentOrder(currentTable);
            const total = calculateTotal(currentOrder);
            const currentNote = loadTableNote(currentTable); 
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // 1. 生成打印内容
            let printContent = `
                <h2>账单</h2> 
                <div class="print-info">
                    <p>日期: ${getTodayDateString()}</p>
                    <p>时间: ${timeString}</p>
                    <p>桌号: ${tableDisplay}</p>
                    ${currentNote ? `<p>备注: ${currentNote}</p>` : ''} 
                </div>
                <hr>
            `;
            
            for (const itemName in currentOrder) {
                const quantity = currentOrder[itemName];
                const item = menuItems.find(i => i.name === itemName);
                if (item && quantity > 0) {
                    const subtotal = item.price * quantity;
                    printContent += `
                        <div class="print-item">
                            <span>${itemName} x ${quantity}</span>
                            <span>${subtotal.toFixed(0)} Ks</span>
                        </div>
                    `;
                }
            }
            
            printContent += `
                <hr>
                <div class="print-total">
                    <span>总计：</span>
                    <span>${total.toFixed(0)} Ks</span>
                </div>
            `;
            
            printArea.innerHTML = printContent;
            
            const originalDisplay = printArea.style.display;
            
            printArea.style.display = 'block'; 
            printArea.style.opacity = '1';
            
            void printArea.offsetWidth; 

            // 3. 使用 html2canvas 将 DOM 元素转为 Canvas
            html2canvas(printArea, { 
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff', 
            }).then(canvas => {
                const imgUrl = canvas.toDataURL('image/png');
                
                const a = document.createElement('a');
                a.href = imgUrl;
                a.download = `账单-${currentTable}-${getTodayDateString()}-${now.getTime()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 4. 恢复 print-area 的原始状态
                printArea.style.display = originalDisplay; 
                printArea.style.opacity = '0';
                printArea.innerHTML = ''; 

                const customAppScheme = 'myposapp://receipt_complete'; 
                setTimeout(() => {
                    window.location.href = customAppScheme;
                }, 100); 

            }).catch(error => {
                console.error("图片生成失败:", error);
                alert("图片生成失败，请检查浏览器控制台。");
                
                printArea.style.display = originalDisplay;
                printArea.style.opacity = '0';
            });
        }

        /**
         * **修改功能:** 结算并清空当前桌子的订单 (新增回收桌号逻辑)
         */
        function settleAndClear() {
            const tableToSettle = currentTable;
            const currentOrder = loadCurrentOrder(tableToSettle);
            const total = calculateTotal(currentOrder);
            const currentNote = loadTableNote(tableToSettle); 
            const tableDisplay = (typeof tableToSettle === 'number' || (!isNaN(parseInt(tableToSettle)) && String(parseInt(tableToSettle)) === String(tableToSettle))) ? `${tableToSettle}号桌` : String(tableToSettle);


            if (total > 0) {
                if (confirm(`确定要结算并清空"${tableDisplay}"账单吗？该订单将被记录在历史中。`)) {
                    // 1. 下载账单图片 (同步调用)
                    printBillToImage();

                    // 2. 记录历史订单到 LocalStorage
                    const todayDate = getTodayDateString();
                    const historyKey = `bbq_orders_by_date_${todayDate}`;
                    let dailyOrders = JSON.parse(localStorage.getItem(historyKey)) || [];
                    
                    dailyOrders.push({
                        table: tableToSettle,
                        timestamp: new Date().toISOString(),
                        order: currentOrder,
                        total: total,
                        note: currentNote 
                    });
                    
                    localStorage.setItem(historyKey, JSON.stringify(dailyOrders));
                    
                    // 3. 清空当前桌子的 LocalStorage 订单和备注
                    localStorage.removeItem(`bbq_order_table_${tableToSettle}`);
                    localStorage.removeItem(`bbq_note_table_${tableToSettle}`);

                    // 4. **核心改动：回收桌号并切换**
                    
                    // 从 activeTables 中移除当前桌号
                    const index = activeTables.indexOf(tableToSettle);
                    if (index > -1) {
                        activeTables.splice(index, 1);
                    }
                    
                    // 移除对应的菜单 DOM 结构
                    const settledMenuContainer = document.getElementById(`table-${tableToSettle}-menu`);
                    if (settledMenuContainer) {
                        settledMenuContainer.remove();
                    }

                    // 确定下一个要显示的桌号
                    let nextTableToShow = 1;
                    if (activeTables.length > 0) {
                        nextTableToShow = activeTables[0]; // 默认切换到最小的活跃桌
                    } else {
                        // 如果所有桌子都结算完了，强制保证 1 号桌存在 (或重新添加 1 号桌)
                        activeTables.push(1); 
                        nextTableToShow = 1;
                    }
                    
                    // 切换到下一个桌号并更新 UI
                    switchTable(nextTableToShow); 
                    
                    alert(`"${tableDisplay}"结算成功并已回收！`);
                }
            } else {
                alert('当前账单为空，无需结算。');
            }
        }
        
        /** * **修改功能:** 预加载并渲染所有**活跃**桌子的菜单界面 
         */
        async function renderAllMenus() {
            if (menuItems.length === 0) {
                await loadMenuItems();
            }
            // **性能优化：只保留当前活跃的菜单 DOM，移除所有非活跃的**
            menuArea.innerHTML = '';

            // 1. Group items by category (一次性操作)
            const categorizedItems = menuItems.reduce((acc, item) => {
                const category = item.category && item.category.trim() !== '' ? item.category.trim() : "其他"; 
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(item);
                return acc;
            }, {});
            const sortedCategories = Object.keys(categorizedItems).sort();

            // 2. Render only for active tables
            for (const tableNum of activeTables) {
                const tableMenuContainer = document.createElement('div');
                tableMenuContainer.id = `table-${tableNum}-menu`;
                tableMenuContainer.classList.add('table-menu-container');

                const order = loadCurrentOrder(tableNum);
                
                // 3. Render items grouped by category
                for (const category of sortedCategories) {
                    const categorySection = document.createElement('div');
                    categorySection.className = 'category-section';

                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.innerHTML = `<span>${category} (${categorizedItems[category].length} 项)</span>`; 
                    categorySection.appendChild(header);

                    const content = document.createElement('div');
                    content.className = 'category-content';

                    for (const item of categorizedItems[category]) {
                        const quantity = order[item.name] || 0;
                        
                        // 
                        // 【【【 这是修改点 (4) - JS 渲染 HTML 结构 】】】
                        //
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('item');
                        itemDiv.setAttribute('data-item-name', item.name);
                        itemDiv.setAttribute('data-table-number', tableNum);
                        // 移除了 1.html 的 itemDiv.setAttribute('onclick', ...)

                        // 采用了 2.html 的 HTML 结构 (无 <img>, onclick 在 item-info 上, input 上有 stopPropagation)
                        itemDiv.innerHTML = `
                            <div class="item-info" onclick="changeQuantity('${item.name}', 1, '${tableNum}')">
                                <h3>${item.name}</h3>
                                <p>价格: ${item.price.toFixed(0)} Ks</p>
                            </div>
                            <div class="item-controls">
                                <button onclick="changeQuantity('${item.name}', 1, '${tableNum}')">+</button>
                                <input type="number" class="quantity-input" data-item-name="${item.name}" data-table-number="${tableNum}" value="${quantity}" oninput="updateBill()" onclick="event.stopPropagation()">
                                <button onclick="changeQuantity('${item.name}', -1, '${tableNum}')">-</button>
                            </div>
                        `;
                        content.appendChild(itemDiv);
                    }
                    
                    categorySection.appendChild(content);
                    tableMenuContainer.appendChild(categorySection);
                }
                
                menuArea.appendChild(tableMenuContainer);
            }
            
            // 初始显示当前桌子
            const currentMenu = document.getElementById(`table-${currentTable}-menu`);
            if (currentMenu) {
                currentMenu.classList.add('active');
            }
        }
        
        /**
         * 针对卡片点击的辅助函数
         * (此函数在新的列表布局中不再被调用，但保留它不会影响功能)
         */
        function changeQuantityFromCard(event, itemName, change, tableNumber) {
            // 确保点击的不是控件区域 (item-controls)
            const isControl = event.target.closest('.item-controls');
            if (isControl) return; 
            changeQuantity(itemName, change, tableNumber);
        }


        /** * 更改指定菜品在指定桌子的数量 */
        function changeQuantity(itemName, change, tableNumber) {
            playSound();
            vibrateDevice();

            // **性能优化点**: 仅查找和更新当前的输入框值，而不是遍历整个 DOM
            // 注意：因为现在只有活跃的桌子才有 DOM，所以查找是高效的
            const input = document.querySelector(`.quantity-input[data-item-name='${itemName}'][data-table-number='${tableNumber}']`);
            if (!input) return;
            
            let quantity = parseInt(input.value) || 0;
            
            if (quantity + change >= 0) {
                quantity += change;
                
                // **性能优化点**: 使用 requestAnimationFrame 确保在下次浏览器重绘前进行 DOM 更新
                requestAnimationFrame(() => {
                    input.value = quantity;
                    updateBill();
                });
            }
        }

        /** * 更新账单显示和总价，并保存当前桌子的订单到 LocalStorage */
        function updateBill() {
            // **性能优化核心**: 减少 DOM 操作，只更新/增删必要的元素
            
            const currentMenuContainer = document.getElementById(`table-${currentTable}-menu`);
            // 如果当前桌号菜单 DOM 结构不存在 (例如刚刚被回收)，则不执行更新
            if (!currentMenuContainer) {
                 billDetails.innerHTML = '';
                 totalPriceSpan.textContent = '0';
                 currentNoteDisplay.textContent = ''; 
                 return;
            }

            // 1. 处理备注
            const currentNote = orderNoteInput.value.trim();
            localStorage.setItem(`bbq_note_table_${currentTable}`, currentNote);
            currentNoteDisplay.textContent = currentNote ? `备注: ${currentNote}` : '';

            // 2. 收集订单数据 (从当前显示页面的 input 中获取)
            const quantityInputs = currentMenuContainer.querySelectorAll('.quantity-input');
            const orderData = {};
            let total = 0;
            let currentOrderNames = new Set(); // 用于追踪当前订单中的菜品名称

            quantityInputs.forEach(input => {
                const itemName = input.getAttribute('data-item-name');
                const quantity = parseInt(input.value) || 0;
                
                if (quantity > 0) {
                    orderData[itemName] = quantity;
                    currentOrderNames.add(itemName);
                    const item = menuItems.find(i => i.name === itemName);
                    if (item) {
                        total += item.price * quantity;
                    }
                }
            });
            
            // 3. **性能优化**: 差异化更新账单明细 DOM
            const existingRows = billDetails.querySelectorAll('.item-row');
            const itemRowsMap = new Map();
            existingRows.forEach(row => {
                const name = row.getAttribute('data-item-name');
                itemRowsMap.set(name, row);
            });
            
            // 遍历新订单数据进行更新或添加
            for (const itemName of currentOrderNames) {
                const quantity = orderData[itemName];
                const item = menuItems.find(i => i.name === itemName);
                const subtotal = item.price * quantity;
                
                if (itemRowsMap.has(itemName)) {
                    // **更新**: 如果元素已存在，则只更新其文本内容
                    const row = itemRowsMap.get(itemName);
                    row.querySelector('.item-name-qty').textContent = `${itemName} (${item.price.toFixed(0)} Ks/份) x ${quantity}`;
                    row.querySelector('.item-total').textContent = `${subtotal.toFixed(0)} Ks`;
                    itemRowsMap.delete(itemName); // 从 Map 中移除，剩余的需要被删除
                } else {
                    // **新增**: 创建新的 DOM 元素
                    const billItemDiv = document.createElement('div');
                    billItemDiv.classList.add('item-row');
                    billItemDiv.setAttribute('data-item-name', itemName); // 标记以便下次更新
                    
                    billItemDiv.innerHTML = `
                        <span class="item-name-qty">${itemName} (${item.price.toFixed(0)} Ks/份) x ${quantity}</span>
                        <span class="item-total">${subtotal.toFixed(0)} Ks</span>
                    `;
                    billDetails.appendChild(billItemDiv);
                }
            }
            
            // 4. **删除**: 遍历 Map 中剩余的元素 (数量已变为 0 或不存在于新订单中)
            itemRowsMap.forEach(row => {
                row.remove();
            });

            // 5. 更新总价
            totalPriceSpan.textContent = total.toFixed(0);
            
            // 6. 保存订单数据到 LocalStorage
            localStorage.setItem(`bbq_order_table_${currentTable}`, JSON.stringify(orderData));
        }
        
        /** * 动态生成桌号选择下拉菜单的选项 (基于 activeTables) */
        function generateTableSelectors() {
            tableDropdownContent.innerHTML = '';
            
            // **核心修改：添加“+ 添加桌号”链接作为第一个元素**
            const addTableLink = document.createElement('a');
            addTableLink.href = '#';
            addTableLink.textContent = '添加桌号';
            addTableLink.classList.add('add-table-link'); // 使用新的 CSS 样式
            addTableLink.onclick = (e) => {
                e.preventDefault();
                addNewTable();
            };
            tableDropdownContent.appendChild(addTableLink);

            // **修改点 2: 遍历 activeTables 添加桌号**
            activeTables.forEach(i => {
                const link = document.createElement('a');
                link.href = '#';
                // 确保桌号显示正确，如果是数字则显示 "X号桌"，否则显示 "X"
                const displayNum = (typeof i === 'number' || (!isNaN(parseInt(i)) && String(parseInt(i)) === String(i))) ? `${i}号桌` : String(i);
                link.textContent = displayNum;
                link.onclick = (e) => {
                    e.preventDefault();
                    switchTable(i);
                };
                tableDropdownContent.appendChild(link);
            });
        }

        // --- 菜单编辑和数据管理函数 (保留 1.html 的，含图片) ---

        /**
         * 读取当前编辑区域的所有输入框值，更新到 menuItems 数组，并保存到 IndexedDB。
         */
        async function saveCurrentEditsAndPersist(silent = false) {
            const nameInputs = document.querySelectorAll('.edit-name');
            const priceInputs = document.querySelectorAll('.edit-price');
            const categoryInputs = document.querySelectorAll('.edit-category');
            
            const dbSavePromises = [];

            for (let i = 0; i < nameInputs.length; i++) {
                const id = parseInt(nameInputs[i].getAttribute('data-id'));
                const itemIndex = menuItems.findIndex(item => item.id === id);

                if (itemIndex !== -1) {
                    menuItems[itemIndex].name = nameInputs[i].value.trim();
                    menuItems[itemIndex].price = parseInt(priceInputs[i].value) || 0;
                    menuItems[itemIndex].category = categoryInputs[i].value.trim(); 

                    dbSavePromises.push(saveMenuItemToDB(menuItems[itemIndex]));
                }
            }
            
            await Promise.all(dbSavePromises);

            if (!silent) {
                 alert('所有菜单项已保存');
            }
        }

        /**
         * 切换到菜单编辑模式
         */
        async function toggleEditMode() {
            if (isSummaryMode) return;
            if (isEditMode) {
                await saveCurrentEditsAndPersist(false); 
                mainContent.style.display = 'flex';
                editContent.style.display = 'none';
                summaryContent.style.display = 'none';
                editLink.textContent = '编辑菜单';
                
                // 【新增】显示控制项
                tableSelectorContainer.style.display = 'inline-block';
                noteInputContainer.style.display = 'flex';
                
                await updateUI();
            } else {
                mainContent.style.display = 'none';
                editContent.style.display = 'block';
                summaryContent.style.display = 'none';
                editLink.textContent = '完成编辑';
                
                // 【新增】隐藏控制项
                tableSelectorContainer.style.display = 'none';
                noteInputContainer.style.display = 'none';
                
                await renderMenuEditor();
            }
            isEditMode = !isEditMode;
        }
        
        /**
         * 渲染菜单编辑器
         */
        async function renderMenuEditor() {
            const editorBody = document.getElementById('menu-editor-body');
            editorBody.innerHTML = '';
            
            for (const item of menuItems) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${item.name}" data-id="${item.id}" class="edit-name"></td>
                    <td><input type="number" value="${item.price}" data-id="${item.id}" class="edit-price"></td>
                    <td><input type="text" value="${item.category || ''}" data-id="${item.id}" class="edit-category"></td> 
                    <td>
                        <input type="file" accept="image/*" data-id="${item.id}" class="edit-image">
                        <img src="${item.image || defaultPlaceholder}" style="width:50px;height:50px;" class="preview-img" data-id="${item.id}">
                    </td>
                    <td>
                        <button onclick="deleteMenuItem(${item.id})" style="background-color: #e74c3c;">删除</button>
                    </td>
                `;
                editorBody.appendChild(row);
            }

            // 添加文件变更监听
            const fileInputs = document.querySelectorAll('.edit-image');
            fileInputs.forEach(input => {
                input.addEventListener('change', handleImageUpload);
            });
        }

        /**
         * 保存所有菜单项
         */
        async function saveAllMenuItems() {
            await saveCurrentEditsAndPersist(false);
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const id = event.target.getAttribute('data-id');
                    const preview = document.querySelector(`.preview-img[data-id="${id}"]`);
                    if (preview) {
                        preview.src = e.target.result;
                    }
                    const itemIndex = menuItems.findIndex(item => item.id == id);
                    if (itemIndex !== -1) {
                        menuItems[itemIndex].image = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        /**
         * 删除菜单项
         */
        async function deleteMenuItem(id) {
            if (confirm("确定要删除这个菜品吗？")) {
                const itemIndex = menuItems.findIndex(item => item.id === id);
                if (itemIndex !== -1) {
                    const itemName = menuItems[itemIndex].name;
                    
                    // 从数据库删除
                    await deleteMenuItemFromDB(id);
                    
                    // 从内存中删除
                    menuItems.splice(itemIndex, 1);
                    
                    alert(`菜品 "${itemName}" 已删除`);
                    await renderMenuEditor();
                }
            }
        }
        
        /**
         * 添加新菜品
         */
        async function addNewItem() {
            await saveCurrentEditsAndPersist(true); // 静默保存所有已编辑内容

            const newItem = {
                name: "新菜品",
                price: 1000,
                category: "其他" 
            };
            
            // 保存到数据库
            const id = await saveMenuItemToDB(newItem);
            newItem.id = id;
            
            // 添加到内存
            menuItems.push(newItem);
            
            // 重新渲染编辑器
            await renderMenuEditor();
        }
        
        // --- 汇总模式函数 (保留 1.html 的，含财务管理) ---
        
        // --- 新增: 资金汇总管理视图切换与数据操作 ---
        let currentSummaryView = 'profit-loss';
        
        /** * 新增功能: 获取每日财务数据 (销售、收入、支出)
         */
        function getDailyFinancialData() {
            const dailyData = {};
            let grandTotalSales = 0;
            let grandTotalIncome = 0;
            let grandTotalExpense = 0;

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // 使用正则表达式从键中提取日期 YYYY-MM-DD
                const date = key.match(/_(\d{4}-\d{2}-\d{2})$/)?.[1];
                if (!date) continue;

                if (!dailyData[date]) {
                    // 初始化每日数据结构
                    dailyData[date] = { sales: 0, income: 0, expense: 0, orders: [], incomes: [], expenses: [] };
                }

                const records = JSON.parse(localStorage.getItem(key));

                if (key.startsWith('bbq_orders_by_date_')) {
                    // 销售额 = 所有订单的总和
                    let dailySales = records.reduce((sum, order) => sum + order.total, 0);
                    dailyData[date].sales += dailySales;
                    dailyData[date].orders.push(...records);
                    grandTotalSales += dailySales;
                } else if (key.startsWith('bbq_incomes_by_date_')) {
                    // 其他收入 = 所有手动记录收入的总和
                    let dailyIncomes = records.reduce((sum, income) => sum + income.amount, 0);
                    dailyData[date].income += dailyIncomes;
                    dailyData[date].incomes.push(...records);
                    grandTotalIncome += dailyIncomes;
                } else if (key.startsWith('bbq_expenses_by_date_')) {
                    // 支出 = 所有手动记录支出的总和
                    let dailyExpenses = records.reduce((sum, expense) => sum + expense.amount, 0);
                    dailyData[date].expense += dailyExpenses;
                    dailyData[date].expenses.push(...records);
                    grandTotalExpense += dailyExpenses;
                }
            }
            
            // 转换为数组并按日期降序排序
            const sortedDates = Object.keys(dailyData).sort().reverse();
            
            // 计算每日净损益
            const result = sortedDates.map(date => {
                const data = dailyData[date];
                // 净损益 = 销售额 + 其他收入 - 支出
                const net = data.sales + data.income - data.expense;
                data.net = net;
                data.date = date;
                return data;
            });

            return {
                dailyRecords: result,
                grandTotals: { sales: grandTotalSales, income: grandTotalIncome, expense: grandTotalExpense }
            };
        }


        /** * 切换汇总模式下的子视图 (已修改) */
        function showSummaryView(view) {
            // 隐藏所有视图
            document.getElementById('profit-loss-view').style.display = 'none'; 
            document.getElementById('income-view').style.display = 'none';
            document.getElementById('expense-view').style.display = 'none';
            
            // 重置按钮透明度
            const buttons = document.querySelectorAll('#summary-nav button');
            buttons.forEach(btn => btn.style.opacity = '0.7');

            currentSummaryView = view;
            
            if (view === 'profit-loss') { // 损益汇总
                document.getElementById('profit-loss-view').style.display = 'block';
                buttons[0].style.opacity = '1.0';
                renderProfitLoss(); 
            } else if (view === 'income') { // 收入管理 (含销售)
                document.getElementById('income-view').style.display = 'block';
                buttons[1].style.opacity = '1.0';
                document.getElementById('income-date').value = getTodayDateString();
                renderIncomes(); 
            } else if (view === 'expense') { // 支出管理
                document.getElementById('expense-view').style.display = 'block';
                buttons[2].style.opacity = '1.0';
                
                // --- 修改: 重置支出表单为单个空行 ---
                const container = document.getElementById('expense-entry-container');
                container.innerHTML = `
                    <div class="expense-entry-row" style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <input type="date" class="expense-date-input" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;"> 
                        <input type="text" class="expense-description-input" placeholder="支出描述" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <input type="number" class="expense-amount-input" placeholder="金额 (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <button onclick="removeExpenseRow(this)" style="background-color: #95a5a6; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">删除</button>
                    </div>
                `;
                // 为该行设置默认日期
                container.querySelector('.expense-date-input').value = getTodayDateString();
                // --- 修改结束 ---
                
                renderExpenses();
            }
        }

        /**
         * 切换到历史汇总模式
         */
        function toggleSummaryMode() {
            if (isEditMode) return;
            isSummaryMode = !isSummaryMode;
            if (isSummaryMode) {
                mainContent.style.display = 'none';
                editContent.style.display = 'none';
                summaryContent.style.display = 'block';
                summaryLink.textContent = '返回点单';
                
                // 【新增】隐藏控制项
                tableSelectorContainer.style.display = 'none';
                noteInputContainer.style.display = 'none';

                // 默认显示损益汇总
                showSummaryView('profit-loss'); 
            } else {
                mainContent.style.display = 'flex';
                summaryContent.style.display = 'none';
                summaryLink.textContent = '查看汇总';
                
                // 【新增】显示控制项
                tableSelectorContainer.style.display = 'inline-block';
                noteInputContainer.style.display = 'flex';
            }
        }
        
        /**
         * 渲染损益汇总数据 (新功能)
         */
        function renderProfitLoss() {
            const summaryContainer = document.getElementById('summary-container');
            summaryContainer.innerHTML = '';
            
            const { dailyRecords } = getDailyFinancialData();
            
            if (dailyRecords.length === 0) {
                summaryContainer.innerHTML = '<p>暂无任何资金记录</p>';
                document.getElementById('grand-total').textContent = '总损益: 0 Ks';
                return;
            }
            
            let grandTotalNet = 0;
            let monthlyTotals = {}; // { 'YYYY-MM': totalNet }
            let dailySummaryHTML = '';

            for (const day of dailyRecords) {
                grandTotalNet += day.net;
                const month = day.date.substring(0, 7);
                if (!monthlyTotals[month]) {
                    monthlyTotals[month] = 0;
                }
                monthlyTotals[month] += day.net;

                // Daily Section Display
                const netColor = day.net >= 0 ? '#27ae60' : '#e74c3c';
                const netText = day.net >= 0 ? '盈利' : '亏损';

                dailySummaryHTML += `
                    <div class="daily-summary-section">
                        <h3>${day.date}</h3>
                        <p style="color: #f39c12; font-weight: 500;">当日销售额: ${day.sales.toFixed(0)} Ks</p>
                        <p style="color: #27ae60; font-weight: 500;">当日其他收入: ${day.income.toFixed(0)} Ks</p>
                        <p style="color: #e74c3c; font-weight: 500;">当日支出: ${day.expense.toFixed(0)} Ks</p>
                        <p class="daily-total" style="font-size: 1.2em; color: ${netColor};">
                            当日净${netText}: ${day.net.toFixed(0)} Ks
                        </p>
                    </div>
                `;
            }

            // Monthly Summary Display
            let monthlySummaryHTML = '<h3 style="margin-top: 0; color: #3498db; border-bottom: 1px solid #3498db; padding-bottom: 10px;">每月损益汇总</h3>';
            
            const sortedMonths = Object.keys(monthlyTotals).sort().reverse();
            for(const month of sortedMonths) {
                const monthNet = monthlyTotals[month];
                const monthColor = monthNet >= 0 ? '#27ae60' : '#e74c3c';
                const monthText = monthNet >= 0 ? '盈利' : '亏损';
                
                monthlySummaryHTML += `
                    <div style="padding: 10px 0; border-bottom: 1px dashed #ddd;">
                        <p style="font-size: 1.1em; font-weight: bold; color: #555;">${month}</p>
                        <p style="font-size: 1.2em; font-weight: bold; text-align: right; color: ${monthColor};">
                            本月净${monthText}: ${monthNet.toFixed(0)} Ks
                        </p>
                    </div>
                `;
            }
            
            // 合并显示: 先月汇总，后日明细
            summaryContainer.innerHTML = monthlySummaryHTML + dailySummaryHTML;


            // 更新总损益
            const grandNetColor = grandTotalNet >= 0 ? '#27ae60' : '#e74c3c';
            const grandNetText = grandTotalNet >= 0 ? '盈利' : '亏损';
            document.getElementById('grand-total').innerHTML = `累计总${grandNetText}: <span style="color: ${grandNetColor}">${grandTotalNet.toFixed(0)} Ks</span>`;
        }
        
        // --- 收入管理函数 (已修改，整合销售订单) ---
        function addIncome() {
            const description = document.getElementById('income-description').value.trim();
            const amount = parseInt(document.getElementById('income-amount').value);
            const date = document.getElementById('income-date').value;

            if (!description || isNaN(amount) || amount <= 0 || !date) {
                alert('请输入有效的描述、金额和日期。');
                return;
            }
            
            const historyKey = `bbq_incomes_by_date_${date}`;
            let dailyIncomes = JSON.parse(localStorage.getItem(historyKey)) || [];

            dailyIncomes.push({
                id: Date.now(),
                description: description,
                amount: amount,
                timestamp: new Date().toISOString(),
                date: date
            });

            localStorage.setItem(historyKey, JSON.stringify(dailyIncomes));
            
            document.getElementById('income-description').value = '';
            document.getElementById('income-amount').value = '';
            
            alert(`已添加其他收入: ${description} (${amount.toFixed(0)} Ks) on ${date}`);
            renderIncomes();
        }

        /**
         * 渲染收入记录 (包含其他收入和销售订单详情)
         */
        function renderIncomes() {
            const incomeList = document.getElementById('income-list');
            incomeList.innerHTML = '';
            
            const { dailyRecords } = getDailyFinancialData();
            let grandTotalIncomePlusSales = 0;

            if (dailyRecords.length === 0) {
                incomeList.innerHTML = '<p>暂无任何收入记录</p>';
                return;
            }

            for (const day of dailyRecords) {
                // Sort sales orders by timestamp
                const sortedOrders = day.orders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                // Sort other incomes by timestamp
                const sortedIncomes = day.incomes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Combine all income types for the day
                const allIncomes = [
                    ...sortedOrders.map(o => ({
                        id: new Date(o.timestamp).getTime(), // Use timestamp for pseudo-ID
                        type: '销售订单',
                        description: `桌号: ${o.table}`,
                        amount: o.total,
                        timestamp: o.timestamp,
                        details: o.order, 
                        note: o.note,
                        date: day.date
                    })),
                    ...sortedIncomes.map(i => ({
                        id: i.id,
                        type: '其他收入',
                        description: i.description,
                        amount: i.amount,
                        timestamp: i.timestamp,
                        date: i.date 
                    }))
                ].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by time

                if (allIncomes.length === 0) continue;

                let dailyTotal = day.sales + day.income;
                grandTotalIncomePlusSales += dailyTotal;
                
                let listHTML = `
                    <div style="background-color: rgba(39, 174, 96, 0.1); padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <p style="font-weight: bold; font-size: 1.2em; color: #27ae60; border-bottom: 1px solid #27ae60; padding-bottom: 5px;">日期: ${day.date}</p>
                        <ul style="list-style-type: none; padding: 0;">
                `;
                
                for (const record of allIncomes) {
                    const timeString = new Date(record.timestamp).toLocaleTimeString();
                    const isOrder = record.type === '销售订单';
                    // 销售订单不能单独删除，只能通过清空全部历史
                    const deleteAction = isOrder ? 'alert(\'销售订单不可单独删除，请清空所有历史账单\')' : `deleteRecord('bbq_incomes_by_date_${record.date}', ${record.id}, 'income')`;
                    const color = isOrder ? '#f39c12' : '#27ae60';
                    
                    let itemDetailsHTML = '';
                    if (isOrder && record.details) {
                        itemDetailsHTML = '<ul style="padding-left: 20px; font-size: 0.9em; color: #555; margin-top: 5px;">';
                        for (const item in record.details) {
                            const qty = record.details[item];
                            const itemData = menuItems.find(i => i.name === item) || { price: 0 };
                            itemDetailsHTML += `<li>${item} x ${qty} (${(itemData.price * qty).toFixed(0)} Ks)</li>`;
                        }
                        itemDetailsHTML += `</ul>`;
                        if(record.note) itemDetailsHTML += `<p style="padding-left: 20px; font-style: italic; color: #777; margin-top: 0;">备注: ${record.note}</p>`;
                    }


                    listHTML += `<li style="padding: 8px 0; border-bottom: 1px dotted #ccc;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <span style="font-weight: ${isOrder ? 'bold' : 'normal'}; color: ${color};">${record.type} - ${record.description} (${timeString})</span>
                                        <span style="min-width: 100px; text-align: right; font-weight: bold; color: ${color};">${record.amount.toFixed(0)} Ks 
                                            <button style="margin-left: 10px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 5px; cursor: pointer;" 
                                                    onclick="${deleteAction}">删除</button>
                                        </span>
                                    </div>
                                    ${itemDetailsHTML}
                                </li>`;
                }
                
                listHTML += `</ul><p class="daily-total" style="font-weight: bold; text-align: right; color: #27ae60; border-top: 1px solid #ddd; padding-top: 5px; margin-top: 10px;">当日总收入: ${dailyTotal.toFixed(0)} Ks</p></div>`;
                
                incomeList.innerHTML += listHTML;
            }
            
            incomeList.innerHTML = `<h3 style="color: #27ae60; text-align: center; margin-bottom: 15px;">累计总收入 (含销售): ${grandTotalIncomePlusSales.toFixed(0)} Ks</h3>` + incomeList.innerHTML;

            document.getElementById('income-date').value = getTodayDateString();
        }


        // --- 支出管理函数 (包含日期) ---
        
        /**
         * 已重写: 记录所有在表单中输入的支出行
         */
        function addExpense() {
            const rows = document.querySelectorAll('#expense-entry-container .expense-entry-row');
            let addedCount = 0;
            let totalAmount = 0;
            let errors = 0;

            // 使用 Map 批量按日期保存
            const savesByDate = new Map();

            rows.forEach((row, index) => {
                const dateInput = row.querySelector('.expense-date-input');
                const descriptionInput = row.querySelector('.expense-description-input');
                const amountInput = row.querySelector('.expense-amount-input');
                
                const date = dateInput.value;
                const description = descriptionInput.value.trim();
                const amount = parseInt(amountInput.value);

                if (!description || isNaN(amount) || amount <= 0 || !date) {
                    errors++;
                    return; // 跳过此行
                }
                
                // 准备要保存的数据
                const expenseRecord = {
                    id: Date.now() + index, // 使用 index 确保 ID 唯一性
                    description: description,
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    date: date
                };
                
                if (!savesByDate.has(date)) {
                    savesByDate.set(date, []);
                }
                savesByDate.get(date).push(expenseRecord);

                addedCount++;
                totalAmount += amount;
            });

            // 执行所有保存操作
            savesByDate.forEach((records, date) => {
                const historyKey = `bbq_expenses_by_date_${date}`;
                // 获取已有记录或创建新数组
                let dailyExpenses = JSON.parse(localStorage.getItem(historyKey)) || [];
                // 添加当天所有的
                dailyExpenses.push(...records);
                // 保存
                localStorage.setItem(historyKey, JSON.stringify(dailyExpenses));
            });

            if (addedCount > 0) {
                alert(`成功添加 ${addedCount} 条支出记录，总金额: ${totalAmount.toFixed(0)} Ks。`);
                if (errors > 0) {
                    alert(`有 ${errors} 条无效记录被跳过。`);
                }
                // 重置表单: 移除除第一行外的所有行，并清空第一行
                const container = document.getElementById('expense-entry-container');
                const allRows = container.querySelectorAll('.expense-entry-row');
                for (let i = allRows.length - 1; i > 0; i--) {
                    allRows[i].remove();
                }
                // 清理并重置第一行
                const firstRow = allRows[0];
                if (firstRow) {
                    firstRow.querySelector('.expense-date-input').value = getTodayDateString();
                    firstRow.querySelector('.expense-description-input').value = '';
                    firstRow.querySelector('.expense-amount-input').value = '';
                }
                renderExpenses(); // 更新历史列表
            } else if (errors > 0) {
                 alert(`所有 ${errors} 条记录都无效，请输入有效信息。`);
            } else {
                alert('请输入有效的支出信息。');
            }
        }

        /**
         * 新增: 添加一个新的支出输入行
         */
        function addNewExpenseRow() {
            const container = document.getElementById('expense-entry-container');
            const newRow = document.createElement('div');
            newRow.className = 'expense-entry-row';
            newRow.style.cssText = 'display: flex; align-items: center; flex-wrap: wrap; gap: 10px;';
            
            newRow.innerHTML = `
                <input type="date" class="expense-date-input" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;"> 
                <input type="text" class="expense-description-input" placeholder="支出描述" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="number" class="expense-amount-input" placeholder="金额 (Ks)" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button onclick="removeExpenseRow(this)" style="background-color: #95a5a6; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">删除</button>
            `;
            
            // 为新行设置默认日期
            newRow.querySelector('.expense-date-input').value = getTodayDateString();
            container.appendChild(newRow);
        }

        /**
         * 新增: 删除一个支出输入行
         */
        function removeExpenseRow(buttonElement) {
            const container = document.getElementById('expense-entry-container');
            if (container.children.length > 1) {
                buttonElement.parentElement.remove();
            } else {
                alert('不能删除最后一行。');
            }
        }


        function renderExpenses() {
            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            
            const { dailyRecords } = getDailyFinancialData();
            let grandTotalExpense = 0;
            
            if (dailyRecords.length === 0) {
                expenseList.innerHTML = '<p>暂无支出记录</p>';
                return;
            }

            for (const day of dailyRecords) {
                const dailyExpenses = day.expenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                if (dailyExpenses.length === 0) continue;

                let dailyTotal = day.expense;
                grandTotalExpense += dailyTotal;
                
                let listHTML = `
                    <div style="background-color: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <p style="font-weight: bold; font-size: 1.2em; color: #e74c3c; border-bottom: 1px solid #e74c3c; padding-bottom: 5px;">日期: ${day.date}</p>
                        <ul style="list-style-type: none; padding: 0;">
                `;
                
                for (const expense of dailyExpenses) {
                    const timeString = new Date(expense.timestamp).toLocaleTimeString();
                    listHTML += `<li style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #eee;">
                                    <span>${expense.description} (${timeString})</span>
                                    <span>${expense.amount.toFixed(0)} Ks 
                                        <button style="margin-left: 10px; background-color: #e74c3c; color: white; border: none; border-radius: 4px; padding: 2px 5px; cursor: pointer;" 
                                                onclick="deleteRecord('bbq_expenses_by_date_${expense.date}', ${expense.id}, 'expense')">删除</button>
                                    </span>
                                </li>`;
                }
                listHTML += `</ul><p class="daily-total" style="font-weight: bold; text-align: right; color: #e74c3c; border-top: 1px solid #ddd; padding-top: 5px; margin-top: 10px;">当日总支出: ${dailyTotal.toFixed(0)} Ks</p></div>`;
                
                expenseList.innerHTML += listHTML;
            }
            
            expenseList.innerHTML = `<h3 style="color: #e74c3c; text-align: center; margin-bottom: 15px;">累计总支出: ${grandTotalExpense.toFixed(0)} Ks</h3>` + expenseList.innerHTML;

             // 重置表单中第一行的日期 (如果存在)
            const firstDateInput = document.querySelector('#expense-entry-container .expense-date-input');
            if(firstDateInput) {
                firstDateInput.value = getTodayDateString();
            }
        }

        // --- 通用删除记录函数 (用于收入、支出) ---
        function deleteRecord(key, id, type) {
            if (!confirm('确定要删除这条记录吗？')) return;

            let dailyRecords = JSON.parse(localStorage.getItem(key));
            const index = dailyRecords.findIndex(record => record.id === id);
            
            if (index > -1) {
                dailyRecords.splice(index, 1);
                
                if (dailyRecords.length === 0) {
                     localStorage.removeItem(key); // 如果当天没有记录了，则移除整个 key
                } else {
                     localStorage.setItem(key, JSON.stringify(dailyRecords));
                }
                
                if (type === 'income') {
                    renderIncomes();
                } else if (type === 'expense') {
                    renderExpenses();
                }
            }
        }
        
        
        /**
         * 导出到Excel (已修改，统一使用 getDailyFinancialData 的数据源)
         */
        function exportToExcel() {
            const data = [];
            data.push(['日期', '类型', '桌号/描述', '时间', '备注', '菜品', '数量', '单价(Ks)', '金额(Ks)', '订单总计/损益(Ks)']);
            
            const { dailyRecords } = getDailyFinancialData();
                
            for (const day of dailyRecords) {
                
                // 1. 销售订单
                for (const order of day.orders) {
                    const timestamp = new Date(order.timestamp);
                    const timeString = `${timestamp.getHours().toString().padStart(2, '0')}:${timestamp.getMinutes().toString().padStart(2, '0')}:${timestamp.getSeconds().toString().padStart(2, '0')}`;
                    
                    let hasItems = false;
                    for (const itemName in order.order) {
                        hasItems = true;
                        const quantity = order.order[itemName];
                        const item = menuItems.find(i => i.name === itemName) || { price: 0 };
                        const subtotal = item.price * quantity;
                        // 日期, 类型, 桌号/描述, 时间, 备注, 菜品, 数量, 单价, 金额, 订单总计/当日总计
                        data.push([day.date, '销售订单', order.table, timeString, order.note || '', itemName, quantity, item.price, subtotal, '']);
                    }
                    if (hasItems) {
                        data[data.length - 1][9] = order.total; // 在订单的最后一行写入总计
                    } else {
                        data.push([day.date, '销售订单', order.table, timeString, order.note || '', '', '', '', 0, order.total]);
                    }
                }
                
                // 2. 其他收入
                for (const income of day.incomes) {
                    const timestamp = new Date(income.timestamp);
                    const timeString = `${timestamp.getHours().toString().padStart(2, '0')}:${timestamp.getMinutes().toString().padStart(2, '0')}:${timestamp.getSeconds().toString().padStart(2, '0')}`;
                    // 日期, 类型, 桌号/描述, 时间, 备注, 菜品, 数量, 单价, 金额, 订单总计/当日总计
                    data.push([day.date, '其他收入', income.description, timeString, '', '', 1, income.amount, income.amount, income.amount]);
                }
                
                // 3. 支出
                for (const expense of day.expenses) {
                    const timestamp = new Date(expense.timestamp);
                    const timeString = `${timestamp.getHours().toString().padStart(2, '0')}:${timestamp.getMinutes().toString().padStart(2, '0')}:${timestamp.getSeconds().toString().padStart(2, '0')}`;
                    // 日期, 类型, 桌号/描述, 时间, 备注, 菜品, 数量, 单价, 金额, 订单总计/当日总计
                    data.push([day.date, '支出', expense.description, timeString, '', '', 1, -expense.amount, -expense.amount, -expense.amount]); // 支出记为负数
                }
                
                // 4. 每日损益总结 (单独一行)
                const netText = day.net >= 0 ? '净盈利' : '净亏损';
                const netAmount = day.net;
                data.push([day.date, '每日总结', netText, '', '', '', '', '', '', netAmount]);
            }
                
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "历史资金记录");
            
            XLSX.writeFile(wb, '历史资金记录.xlsx');
        }
            
            /**
             * 清空所有历史账单
             */
            function clearAllHistory() {
                if (confirm("确定要清空所有历史销售订单、收入和支出记录吗？此操作不可恢复！")) {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('bbq_orders_by_date_') || 
                            key.startsWith('bbq_incomes_by_date_') ||
                            key.startsWith('bbq_expenses_by_date_')) {
                            keysToRemove.push(key);
                        }
                    }
                    
                    for (const key of keysToRemove) {
                        localStorage.removeItem(key);
                    }
                    
                    alert("所有历史记录已清空");
                    // 清空后重新渲染当前激活的视图
                    if (currentSummaryView === 'profit-loss') renderProfitLoss();
                    if (currentSummaryView === 'income') renderIncomes();
                    if (currentSummaryView === 'expense') renderExpenses();
                }
            }

            /** * 统一更新用户界面 */
            async function updateUI() {
                await loadMenuItems();
                await renderAllMenus();
                generateTableSelectors();
                updateBill();
                const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}号桌` : String(currentTable);
                settleButton.textContent = `结算并清空${tableDisplay}`;
            }

            /** * 应用程序初始化函数 */
            async function initializeUI() {
                initAudioContext(); 
                await openDB();
                await loadMenuItems();
                
                // **修改点 3: 初始化 activeTables**
                // 1. 检查是否有历史活跃桌号（如果程序在开单中关闭）
                const activeOrderKeys = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('bbq_order_table_')) {
                        // 移除前缀获取桌号标识
                        let tableIdentifier = key.replace('bbq_order_table_', '');
                        
                        // 尝试将标识符转换回数字 (如果它是纯数字)
                        const numberCheck = parseInt(tableIdentifier);
                        if (!isNaN(numberCheck) && String(numberCheck) === tableIdentifier) {
                            tableIdentifier = numberCheck;
                        }
                        
                        // 检查订单是否有内容
                        if (JSON.parse(localStorage.getItem(key)) && Object.keys(JSON.parse(localStorage.getItem(key))).length > 0) {
                            activeOrderKeys.push(tableIdentifier);
                        }
                    }
                }
                
                if (activeOrderKeys.length > 0) {
                    // 使用与 addNewTable 中相同的排序逻辑
                    activeTables = activeOrderKeys.sort((a, b) => {
                        const aIsNum = typeof a === 'number' || (typeof a === 'string' && !isNaN(parseInt(a)));
                        const bIsNum = typeof b === 'number' || (typeof b === 'string' && !isNaN(parseInt(b)));
                        
                        if (aIsNum && bIsNum) {
                            return (parseInt(a) || Infinity) - (parseInt(b) || Infinity);
                        } else if (aIsNum) {
                            return -1;
                        } else if (bIsNum) {
                            return 1;
                        } else {
                            return String(a).localeCompare(String(b));
                        }
                    });
                } else {
                    activeTables = [1]; // 强制确保 1 号桌始终存在
                }

                // 2. 确定当前桌号
                let lastTable = localStorage.getItem('bbq_last_table');
                
                // 确保 lastTable 转换成正确的类型（数字或字符串）
                const numberCheck = parseInt(lastTable);
                if (!isNaN(numberCheck) && String(numberCheck) === lastTable) {
                    lastTable = numberCheck;
                }

                if (lastTable !== null && activeTables.includes(lastTable)) {
                    currentTable = lastTable;
                } else {
                    currentTable = activeTables[0] || 1; 
                }
                
                orderNoteInput.addEventListener('input', updateBill); // 监听备注输入框变化
                orderNoteInput.value = loadTableNote(currentTable); // 初始加载备注

                await renderAllMenus(); // 渲染所有活跃桌号的菜单 DOM
                generateTableSelectors(); // 填充下拉菜单
                updateBill();
                
                const tableDisplay = (typeof currentTable === 'number' || (!isNaN(parseInt(currentTable)) && String(parseInt(currentTable)) === String(currentTable))) ? `${currentTable}号桌` : String(currentTable);
                settleButton.textContent = `结算并清空${tableDisplay}`;
            }
            
            // 绑定 AudioContext 恢复逻辑到用户首次点击
            document.addEventListener('click', () => {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().catch(e => console.error("AudioContext 恢复失败:", e));
                }
            }, { once: true });


            // 绑定 DOMContentLoaded 事件
            document.addEventListener('DOMContentLoaded', () => {
                initializeUI();
            });
    </script>
</body>
</html>
